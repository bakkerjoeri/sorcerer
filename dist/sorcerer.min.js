!function(t){var e={};function i(s){if(e[s])return e[s].exports;var o=e[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class s{constructor(t){this.setSize(t),this.viewports=[],this.entities=[]}step(t){this.entities.forEach(e=>{e.step(t)}),this.viewports.filter(t=>t.isActive()).forEach(e=>{e.step(t)})}draw(t){this.viewports.filter(t=>t.isActive()).forEach(e=>{e.draw(t,this.canvas)})}addViewport(t){this.viewports.push(t),t.setRoom(this)}useCanvas(t){this.canvas=t,this.context=t.getContext("2d")}addGameObject(t){this.entities.push(t)}getEntities(){return this.entities}setSize(t){this.size=t}getSize(){return this.size}setBackgroundColor(t){this.backgroundColor=t}getBackgroundColor(){return this.backgroundColor}drawBackground(t,e,i){t.fillStyle=this.backgroundColor,t.fillRect(e.x,e.y,i.width,i.height),t.strokeStyle="#bad455",t.strokeRect(e.x,e.y,i.width,i.height)}}const o={position:{x:0,y:0},origin:{x:0,y:0},active:!0};class n{constructor(t,e={}){this.setSize(t),e=Object.assign({},o,e),this.position=e.position,this.origin=e.origin,e.active?this.activate():this.deactivate()}activate(){this.active=!0}deactivate(){this.active=!1}isActive(){return this.active}setRoom(t){this.room=t}followGameObject(t){this.gameObjectToFollow=t}setSize(t){this.size=t}step(){if(this.gameObjectToFollow&&this.gameObjectToFollow.sprite&&this.gameObjectToFollow.sprite.size){let t={x:this.gameObjectToFollow.position.x-this.size.width/2+this.gameObjectToFollow.sprite.size.width/2,y:this.gameObjectToFollow.position.y-this.size.height/2+this.gameObjectToFollow.sprite.size.height/2};t.x<0&&(t.x=0),t.y<0&&(t.y=0),t.x>this.room.size.width-this.size.width&&(t.x=this.room.size.width-this.size.width),t.y>this.room.size.height-this.size.height&&(t.y=this.room.size.height-this.size.height),this.position=t}}draw(t,e){let i=e.getContext("2d");this.clearDrawing(e.getContext("2d")),this.room.drawBackground(i,{x:this.origin.x,y:this.origin.y},{width:this.size.width,height:this.size.height}),this.room.entities.filter(t=>t.visible).forEach(i=>{i.draw(t,e,this)})}drawMiddle(t){t.strokeStyle="#bad455",t.beginPath(),t.moveTo(this.origin.x,this.origin.y),t.lineTo(this.origin.x+this.size.width,this.origin.y+this.size.height),t.stroke(),t.beginPath(),t.moveTo(this.origin.x+this.size.width,this.origin.y),t.lineTo(this.origin.x,this.origin.y+this.size.height),t.stroke()}clearDrawing(t){t.clearRect(this.origin.x,this.origin.y,this.size.width,this.size.height)}}class r{constructor(t,e,i,s){this.setName(t),this.setImage(e),this.setOrigin(i),this.setSize(s)}setName(t){this.name=t}setImage(t){this.imageLoaded=!1,this.image=t,this.image.addEventListener("load",()=>{this.imageLoaded=!0})}setOrigin(t){this.origin=t}setSize(t){this.size=t}getName(){return this.name}getImage(){return this.image}getOrigin(){return this.origin}getSize(){return this.size}onImageLoaded(t){this.imageLoaded?t():this.image.addEventListener("load",t)}}const h={origin:{x:0,y:0},frameIndex:0,framesPerSecond:1,looping:!0};class a{static createFromDefinition(t){let e=function(t){let e=[];if(t.hasOwnProperty("file")){let i=new Image;i.src=t.file,t.cells.forEach(t=>{let s=new r(t.name,i,t.origin,t.size);e.push(s)})}return e}(t),i=t.frames.map(t=>e.find(e=>e.getName()===t));return new a(i,{framesPerSecond:t.framesPerSecond||0,origin:t.origin||{x:0,y:0}})}constructor(t,e={}){this.setFrames(t),(e=Object.assign({},h,e)).hasOwnProperty("size")?this.size=e.size:this.size=function(t){let e=0,i=0;return t.forEach(t=>{t.size.width>e&&(e=t.size.width),t.size.height>i&&(i=t.size.height)}),{width:e,height:i}}(this.getFrames()),this.setOrigin(e.origin),this.setCurrentFrameIndex(e.frameIndex),this.setFramesPerSecond(e.framesPerSecond),this.looping=e.looping,this.timeOfPreviousFrame=0}setFrames(t=[]){Array.isArray(t)?this.frames=t:this.frames=t instanceof r?[t]:[]}getFrames(){return this.frames}setFramesPerSecond(t){this.framesPerSecond=t}getFramesPerSecond(){return this.framesPerSecond}setCurrentFrameIndex(t){this.frames[t]&&(this.currentFrameIndex=t)}getCurrentFrame(){return this.frames[this.currentFrameIndex]}step(t){let e=this.getFramesPerSecond();if(0!==e&&(this.looping||this.currentFrameIndex!==this.frames.length-1)){let i=(t-this.timeOfPreviousFrame)/(1e3/e);i>0&&(i=Math.floor(i)),i<0&&(i=Math.ceil(i)),0!==i&&(this.timeOfPreviousFrame=t,this.setCurrentFrameIndex(l(this.currentFrameIndex,i,this.frames.length,this.looping)))}}draw(t,e,i){let s=e.getContext("2d"),o=this.getCurrentFrame();o&&s.drawImage(o.getImage(),o.getOrigin().x,o.getOrigin().y,o.getSize().width,o.getSize().height,i.x,i.y,this.size.width,this.size.height)}nextFrame(){this.currentFrameIndex=l(this.currentFrameIndex,1,this.frames.length,this.looping)}previousFrame(){this.currentFrameIndex=l(this.currentFrameIndex,-1,this.frames.length,this.looping)}setOrigin(t){this.origin=t}getOrigin(){return this.origin}}function l(t,e,i,s=!0){if(0===(e=Math.round(e)))return t;if(s){let s=(t+e)%i;return s<0?s+i:s}if(!s){let s=t+e;return s>i-1?i-1:s<0?0:s}}class c{static loadFile(t,e){if("json"===e)return function(t){return fetch(t,{method:"GET",headers:new Headers({"Content-Type":"application/json"})}).then(t=>t.json())}(t);throw new Error(`Unable to load files of type "${e}"`)}}const d="SPRITE",u=new Map;let p;class g{static async loadLibrary(t){p=this.library=await c.loadFile(t,"json")}static get(t,e){return u.has(t)||e===d&&u.set(t,function(t){let e=p.find(e=>e.name===t);if(!e)throw new Error(`No sprite found for "${t}"`);return a.createFromDefinition(e)}(t)),u.get(t)}}const m=[];class w{static startTicking(){!async function t(e){for(let t of e.slice(0))0===t.time&&(await t.action(),e.splice(e.indexOf(t),1));e.forEach(t=>{t.time>0?t.time=t.time-1:t.time=0});t(e)}(m)}static schedule(t,e){if(e<0)throw new Error("Cannot schedule an item in the past");m.push({action:t,time:e})}static unschedule(t){m.splice(m.indexOf(t),1)}}class v{constructor(t={}){this.room=t.room,this.level=t.level}start(){if(!this.level)throw new Error("Cannot start without a level.");window.requestAnimationFrame(this.loop.bind(this)),w.startTicking(this.level.actors)}loop(t){if(!this.room)throw new Error("Cannot start updating without a room.");this.room.step(t),this.room.draw(t),window.requestAnimationFrame(this.loop.bind(this))}}class f{constructor(t){this.position=t,this.actors=[],this.structures=[]}addActor(t){this.actors.push(t)}removeActor(t){let e=this.actors.indexOf(t);-1!==e&&this.actors.splice(e,1)}addStructure(t){this.structures.push(t)}removeStructure(t){let e=this.structures.findIndex(t);-1!==e&&this.actors.splice(e,1)}getEntities(){return this.structures.concat(this.actors)}getActors(){return this.actors}getSolidEntities(t=[]){return this.getEntities().filter(e=>!0===e.solid&&!t.includes(e))}getSolidActors(t=[]){return this.getActors().filter(e=>!0===e.solid&&!t.includes(e))}hasSolidEntities(t=[]){return this.getSolidEntities(t).length>0}hasSolidActors(t=[]){return this.getSolidActors(t).length>0}}class y{constructor(t,e){this.size=t,this.room=e,this.tiles=function(t){let e=[];for(let i=0;i<t.width;i+=1){e[i]=[];for(let s=0;s<t.height;s+=1)e[i][s]=new f({x:i,y:s})}return e}(t),this.actors=[],this.structures=[]}addActor(t,e){t.level=this,this.actors.push(t),this.forEachTileInBoundaries(e,t.sizeInLevel,e=>{e.addActor(t)}),t.setPositionInLevel(e),this.room.addGameObject(t)}addStructure(t,e){t.level=this,this.structures.push(t),this.forEachTileInBoundaries(e,t.sizeInLevel,e=>{e.addStructure(t)}),t.setPositionInLevel(e),this.room.addGameObject(t)}findTileAtPosition(t){return this.tiles[t.x][t.y]}forEachTile(t){this.tiles.forEach(e=>{e.forEach(t)})}forEachTileInBoundaries(t,e,i){for(let s=t.x;s<t.x+e.width;s+=1)for(let o=t.y;o<t.y+e.height;o+=1){let t={x:s,y:o};this.hasTileAtPosition(t)&&i(this.findTileAtPosition(t))}}hasTileAtPosition(t){return Boolean(this.tiles[t.x]&&this.tiles[t.x][t.y])}moveActorFromPositionToPosition(t,e,i){this.forEachTileInBoundaries(e,t.sizeInLevel,e=>{e.removeActor(t)}),this.forEachTileInBoundaries(i,t.sizeInLevel,e=>{e.addActor(t)}),t.setPositionInLevel(i)}getSolidEntitiesInBoundaries(t,e,i=[]){let s=[];return this.forEachTileInBoundaries(t,e,t=>{s=s.concat(t.getSolidEntities(i))}),s}hasSolidEntitiesInBoundaries(t,e,i=[]){return this.getSolidEntitiesInBoundaries(t,e,i).length>0}getSolidActorsInBoundaries(t,e,i=[]){let s=[];return this.forEachTileInBoundaries(t,e,t=>{s=s.concat(t.getSolidActors(i))}),s}hasSolidActorsInBoundaries(t,e,i=[]){return this.getSolidActorsInBoundaries(t,e,i).length>0}areBoundariesWithinLevelBoundaries(t,e){return t.x>=0&&t.y>=0&&t.x+e.width<=this.size.width&&t.y+e.height<=this.size.height}}const x={spriteName:"",position:{x:0,y:0},positioning:"absolute",size:{width:0,height:0},solid:!0,visible:!0};class P{constructor(t={}){t=Object.assign({},x,t),this.setSprite(t.spriteName),this.setPosition(t.position),this.setPositioning(t.positioning),this.setSize(t.size),this.setSolidity(t.solid),this.setVisibility(t.visible),this.events=new Map}step(t){this.sprite&&this.sprite.step(t)}draw(t,e,i){e.getContext("2d");if(this.hasOwnProperty("sprite")&&this.hasOwnProperty("position")&&this.position.hasOwnProperty("x")&&this.position.hasOwnProperty("y")){let s;s=(this.positioning="absolute")?{x:this.position.x+this.sprite.origin.x-(i.position.x-i.origin.x),y:this.position.y+this.sprite.origin.y-(i.position.y-i.origin.y)}:{x:this.position.x+this.sprite.origin.x,y:this.position.y+this.sprite.origin.y},this.sprite.draw(t,e,s)}}useSpriteWithName(t){t.length>0&&this.setSprite(g.get(t,"SPRITE"))}setSprite(t){this.sprite=t}setPosition(t){this.position=t}setPositioning(t){this.positioning=t}getPosition(){return this.position}setSolidity(t){this.solid=t}setVisibility(t){this.visible=t}show(){this.setVisibility(!0)}hide(){this.setVisibility(!1)}isSolid(){return this.solid}isVisible(){return this.visible}setSize(t){this.size=t}getSize(){return this.size}changePosition(t){let e=this.getPosition();this.setPosition({x:e.x+t.x,y:e.y+t.y})}addEventListener(t,e,i={},s=!0){return!function(){let t=!1;try{let e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("test",null,e),window.removeEventListener("test",null,e)}catch(t){}return t}()?window.addEventListener(t,e,s):("wheel"!==t&&"mousewheel"!==t&&"touchstart"!==t&&"touchmove"!==t||(i.passive=!0),window.addEventListener(t,e,i,s)),function(t,e,i,s,o){let n=function t(e,i=6){const s=2+i;let o=Math.random().toString(36).substring(2,s);if(e.has(o))return t(e,i);return o}(t);return t.set(n,new Map([["type",e],["callback",i],["options",s],["useCapture",o]])),n}(this.events,t,e,i,s)}removeEventListener(t){if(this.events.has(t)){let e=this.events.get(t);window.removeEventListener(e.get("type"),e.get("callback"),e.get("options"),e.get("useCapture")),this.events.delete(t)}}removeAllEventListeners(){for(let t of this.events.keys())this.removeEvent(t)}}class I extends P{constructor(t){super(t)}setPositionInLevel(t){this.positionInLevel=t}setSizeInLevel(t){this.sizeInLevel=t}step(t){super.step(t),this.position={x:16*this.positionInLevel.x,y:16*this.positionInLevel.y},this.size={width:16*this.sizeInLevel.width,height:16*this.sizeInLevel.height}}}const A=document.querySelector(".js-log");class b{static showMessage(t){let e=document.createElement("li");e.classList.add("log__item"),e.innerHTML=t,A.appendChild(e)}}const L={strength:1,maxHealth:1,moveCost:100,attackCost:100};class z extends I{constructor(t,e){super(e),this.applyCreatureDefinition(t),w.schedule(this.takeAction.bind(this),0,this)}applyCreatureDefinition(t){this.type=t.type,this.applyStats(t.stats),this.useSpriteWithName(t.spriteName),this.setSizeInLevel(t.size),this.setSolidity(t.solid),this.setDeathrattle(t.deathrattle)}applyStats(t){this.stats=Object.assign({},L,t),(void 0===this.health||this.health>this.stats.maxHealth)&&(this.health=this.stats.maxHealth)}setDeathrattle(t){"function"==typeof t&&(this.deathrattle=t.bind(this))}takeAction(){return new Promise(t=>{t()})}wait(){w.schedule(this.takeAction.bind(this),this.stats.moveCost,this)}canMove(){return this.canMoveToPosition({x:this.positionInLevel.x+1,y:this.positionInLevel.y})||this.canMoveToPosition({x:this.positionInLevel.x,y:this.positionInLevel.y+1})||this.canMoveToPosition({x:this.positionInLevel.x-1,y:this.positionInLevel.y})||this.canMoveToPosition({x:this.positionInLevel.x,y:this.positionInLevel.y-1})}canMoveToPosition(t){return this.level.hasTileAtPosition(t)&&!this.level.hasSolidEntitiesInBoundaries(t,this.sizeInLevel,[this])&&this.level.areBoundariesWithinLevelBoundaries(t,this.sizeInLevel)}moveTo(t){return this.level.moveActorFromPositionToPosition(this,this.positionInLevel,t),w.schedule(this.takeAction.bind(this),this.stats.moveCost,this),!0}canAttackPosition(t){return this.level.getSolidActorsInBoundaries(t,this.sizeInLevel,[this]).some(t=>t.canBeAttacked())}attackPosition(t){let e=this.level.getSolidActorsInBoundaries(t,this.sizeInLevel,[this]).filter(t=>t.canBeAttacked());return 0!==e.length&&(e.forEach(t=>{this.attackTarget(t)}),!0)}attackTarget(t){b.showMessage(`<em>${this.type}</em> attacks <em>${t.type}</em>`),t.applyDamage(this.calculateAttackDamage()),w.schedule(this.takeAction.bind(this),this.stats.attackCost,this)}calculateAttackDamage(){return this.stats.strength}applyDamage(t){b.showMessage(`<em>${this.type}</em> takes ${t} damage`),this.reduceHealth(t)}restoreHealth(t){this.changeHealth(this.health+t)}reduceHealth(t){this.changeHealth(this.health-t)}changeHealth(t){t>this.stats.maxHealth?(this.health=this.stats.maxHealth,b.showMessage(`<em>${this.type}</em> health max at ${this.health}`)):t<=0?(this.health=0,this.die()):(this.health=t,b.showMessage(`<em>${this.type}</em> health is ${this.health}/${this.stats.maxHealth}`))}canBeAttacked(){return!this.dead}die(){this.dead=!0,this.solid=!1,delete this.sprite,"function"==typeof this.deathrattle&&this.deathrattle(this.level),b.showMessage(`<em>${this.type}</em> is dead`)}}class S{constructor(t){this.owner=t,this.goals=[]}act(){this.processGoal(this.goals[0])}processGoal(t){if(!t.isFinished(this.owner))return 0===t.subGoals.length&&t.takeAction(this.owner).catch(()=>{if(t.originalGoal)return t.originalGoal.subGoals.length=0,this.processGoal(t.originalGoal)}),t.subGoals.length>0?this.processGoal(t.subGoals[0]):void 0;t.originalGoal&&(t.originalGoal.subGoals.splice(t.originalGoal.subGoals.indexOf(t),1),this.processGoal(t.originalGoal))}processFinishedGoal(t){t.originalGoal.subGoals.splice(t.originalGoal.subGoals.indexOf(t),1)}processFailedGoal(t){t.originalGoal.subGoals.length=0}}class k{constructor(t){this.subGoals=[],this.originalGoal=t}takeAction(){throw new Error("This method should be implemented.")}isFinished(){throw new Error("This method should be implemented.")}}class E{constructor(t){this.cellMap=function(t){let e=[];for(let i=0;i<t.width;i+=1){e[i]=[];for(let s=0;s<t.height;s+=1)e[i][s]=new T({x:i,y:s})}return e}(t)}findPath(t,e){let i=this.findNeighbours(t),s=this.findCellAtPosition(t),o=this.findCellWithSmallestDistance(i);o.weight<s.weight&&(e(o.position),this.findPath(o.position,e))}calculate(){let t=[],e=[];for(this.forEachCell(e=>{e.passable&&t.push(e)});t.length;){let i=this.findCellWithSmallestDistance(t);t.splice(t.indexOf(i),1),this.findNeighbours(i.position).forEach(t=>{i.weight+1<t.weight&&(t.weight=i.weight+1)}),e.push(i)}}findCellWithSmallestDistance(t){let e;return t.forEach(t=>{(!e||e.weight>t.weight)&&(e=t)}),e}draw(){let t=[];this.forEachCell((e,i)=>{t[i]=`${t[i]||""}${e.passable?e.weight===1/0?" .":1===e.weight.toString().length?` ${e.weight}`:e.weight:" #"} `});let e="";t.forEach(t=>{e=`${e}${t}\n`}),console.log(e)}findNeighbours(t){let e=[];if(this.hasCellAtPosition({x:t.x,y:t.y-1})){let i=this.findCellAtPosition({x:t.x,y:t.y-1});i.passable&&e.push(i)}if(this.hasCellAtPosition({x:t.x+1,y:t.y})){let i=this.findCellAtPosition({x:t.x+1,y:t.y});i.passable&&e.push(i)}if(this.hasCellAtPosition({x:t.x,y:t.y+1})){let i=this.findCellAtPosition({x:t.x,y:t.y+1});i.passable&&e.push(i)}if(this.hasCellAtPosition({x:t.x-1,y:t.y})){let i=this.findCellAtPosition({x:t.x-1,y:t.y});i.passable&&e.push(i)}return e}forEachCell(t){this.cellMap.forEach(e=>{e.forEach((e,i)=>{t(e,i)})})}findCellAtPosition(t){return this.cellMap[t.x][t.y]}hasCellAtPosition(t){return this.cellMap[t.x]&&this.cellMap[t.x][t.y]}}class T{constructor(t,e=1/0,i=!0){this.weight=e,this.passable=i,this.position=t}setWeight(t){this.weight=t}resetWeight(){this.setWeight(1/0)}setAsTarget(){this.setWeight(0)}setPassability(t){this.passable=t}}class C extends k{constructor(t){super(t),this.moved=!1}takeAction(t){return new Promise((e,i)=>{if(t.dead)return i();let s={x:t.positionInLevel.x,y:t.positionInLevel.y-1};return t.canMoveToPosition(s)?(t.moveTo(s),this.moved=!0,e()):i()})}isFinished(){return this.moved}}class F extends k{constructor(t){super(t),this.moved=!1}takeAction(t){return new Promise((e,i)=>{if(t.dead)return i();let s={x:t.positionInLevel.x+1,y:t.positionInLevel.y};return t.canMoveToPosition(s)?(t.moveTo(s),this.moved=!0,e()):i()})}isFinished(){return this.moved}}class O extends k{constructor(t){super(t),this.moved=!1}takeAction(t){return new Promise((e,i)=>{if(t.dead)return i();let s={x:t.positionInLevel.x,y:t.positionInLevel.y+1};return t.canMoveToPosition(s)?(t.moveTo(s),this.moved=!0,e()):i()})}isFinished(){return this.moved}}class M extends k{constructor(t){super(t),this.moved=!1}takeAction(t){return new Promise((e,i)=>{if(t.dead)return i();let s={x:t.positionInLevel.x-1,y:t.positionInLevel.y};return t.canMoveToPosition(s)?(t.moveTo(s),this.moved=!0,e()):i()})}isFinished(){return this.moved}}class B extends k{constructor(t,e){super(e),this.position=t}takeAction(t){return console.log(`${t.type} will wants to move to position`,this.position),new Promise((e,i)=>{if(!t.canMoveToPosition(this.position))return console.log(`${t.type} cannot move to position`,this.position),i();let s=new E(t.level.size);if(s.findCellAtPosition(this.position).setAsTarget(),t.level.forEachTileInBoundaries({x:0,y:0},t.level.size,e=>{!e.hasSolidEntities([t])&&t.canMoveToPosition(e.position)||s.findCellAtPosition(e.position).setPassability(!1)}),s.calculate(),s.draw(),s.findCellAtPosition(t.positionInLevel).weight===1/0)return i();let o=t.positionInLevel;return s.findPath(t.positionInLevel,t=>{o.y<t.y&&this.subGoals.push(new O(this)),o.x<t.x&&this.subGoals.push(new F(this)),o.y>t.y&&this.subGoals.push(new C(this)),o.x>t.x&&this.subGoals.push(new M(this)),o=t}),e()})}isFinished(t){return t.positionInLevel.x===this.position.x&&t.positionInLevel.y===this.position.y}}class G extends k{takeAction(t){return console.log(`${t.type} will try to wander around...`,t.positionInLevel),new Promise(e=>{if(!t.canMove())return console.log(`${t.type} cannot seem to move anywhere`),t.wait(),e();let i=this.findPossiblePositionsInLevel(t,t.level,t.positionInLevel);return 0===i.length?(t.wait(),e()):(this.subGoals.push(new B(function(t){if(console.log("choosing from",t),0===t.length)throw new Error("Cannot choose from zero choices.");return t[Math.floor(Math.random()*(t.length-1+1))]}(i),this)),e())})}isFinished(){return!1}findPossiblePositionsInLevel(t,e,i){let s=[],o=new E(e.size);return o.findCellAtPosition(i).setAsTarget(),e.forEachTileInBoundaries({x:0,y:0},e.size,e=>{!e.hasSolidEntities([t])&&t.canMoveToPosition(e.position)||e.position.x===i.x&&e.position.y===i.y||o.findCellAtPosition(e.position).setPassability(!1)}),o.draw(),o.calculate(),o.draw(),o.findCellAtPosition(i).weight!==1/0&&o.forEachCell(t=>{t.weight!==1/0&&t.passable&&s.push(t.position)}),s}}class j extends z{constructor(t,e){super(t,e),this.brain=new S(this),this.brain.goals.push(new G)}takeAction(){return new Promise(t=>{this.dead||this.brain.act(),t()})}}class D extends I{constructor(t,e){super(e),this.applyStructureDefinition(t)}applyStructureDefinition(t){this.type=t.type,this.useSpriteWithName(t.spriteName),this.setSizeInLevel(t.size),this.setSolidity(t.solid),this.setCanBeAttacked(t.canBeAttacked)}setCanBeAttacked(t=!1){this.attackable=t}canBeAttacked(){return this.attackable}}const N={type:"grave",spriteName:"grave",size:{width:1,height:1},solid:!0},$={type:"knight",stats:{maxHealth:10,strength:3,moveCost:100,attackCost:100},spriteName:"knight",size:{width:1,height:1},solid:!0,deathrattle:function(t){t.addStructure(new D(N),this.positionInLevel)}},H={type:"slime",stats:{maxHealth:16,strength:1,moveCost:200,attackCost:200},spriteName:"slime",size:{width:1,height:1},solid:!0},W={type:"king slime",stats:{maxHealth:28,strength:2,moveCost:400,attackCost:400},spriteName:"kingslime",size:{width:2,height:2},solid:!0,deathrattle:function(t){t.addActor(new j(H),this.positionInLevel),t.addActor(new j(H),{x:this.positionInLevel.x+1,y:this.positionInLevel.y}),t.addActor(new j(H),{x:this.positionInLevel.x,y:this.positionInLevel.y+1}),t.addActor(new j(H),{x:this.positionInLevel.x+1,y:this.positionInLevel.y+1})}},_={type:"tree",spriteName:"tree",size:{width:1,height:1},solid:!0},R={type:"wall",spriteName:"wall",size:{width:1,height:1},solid:!0},V="random",q="locked_up_knight",K="only_creatures",U="king_slime_dijkstra_test";class J{static createLevel(t,e,i){if(i===V){let i=new y({width:36,height:24},t);return i.addActor(e,{x:18,y:12}),(i=i).forEachTile(t=>{if(!t.hasSolidEntities()){if(Q(40))return void i.addActor(new j(H),t.position);if(Q(240))return void i.addActor(new j($),t.position);if(Q(40))return void i.addStructure(new D(_),t.position);if(Q(200))return void i.addStructure(new D(N),t.position);if(Q(10))return void i.addStructure(new D(R),t.position)}!i.hasSolidEntitiesInBoundaries(t.position,W.size)&&i.areBoundariesWithinLevelBoundaries(t.position,W.size)&&Q(240)&&i.addActor(new j(W),t.position)}),i}var s;if(i===q){let i=new y({width:10,height:10},t);return i.addActor(e,{x:4,y:3}),i.addActor(new j($),{x:3,y:3}),function(t,e){t.forEachTile(i=>{i.hasSolidEntities()||i.position.y===e.y||t.addStructure(new D(R),i.position)})}(i,{x:3,y:3}),i}if(i===K){let i=new y({width:36,height:24},t);return i.addActor(e,{x:18,y:12}),function(t){t.forEachTile(e=>{if(!t.hasSolidEntitiesInBoundaries(e.position,W.size)&&t.areBoundariesWithinLevelBoundaries(e.position,W.size)&&Q(240))t.addActor(new j(W),e.position);else if(!e.hasSolidEntities()){if(Q(40))return void t.addActor(new j(H),e.position);if(Q(240))return void t.addActor(new j($),e.position)}})}(i),i}if(i===U){let i=new y({width:8,height:8},t);return i.addActor(e,{x:7,y:0}),i.addActor(new j(W),{x:0,y:4}),i.addActor(new D(_),{x:7,y:7}),i.addActor(new D(_),{x:2,y:5}),i.addActor(new D(R),{x:0,y:3}),i.addActor(new D(R),{x:6,y:5}),i}}}function Q(t){return 1===Math.floor(Math.random()*t+1)}class X extends z{constructor(t,e){super(t,e),b.showMessage(`<em>${this.type}</em> awakens...`)}takeAction(){return new Promise(t=>{this.dead?(w.schedule(this.takeAction.bind(this),this.stats.moveCost,this),window.setTimeout(t,1e3)):this.keyDownEvent=this.addEventListener("keydown",e=>{this.handleKeyPressed(e,t)})})}handleKeyPressed(t,e){let i=!1;" "!==t.key&&"5"!==t.key||(t.preventDefault(),b.showMessage(`${this.type} waits...`),this.wait(),i=!0),"ArrowUp"!==t.key&&"8"!==t.key||(t.preventDefault(),i=this.actNorth()),"ArrowRight"!==t.key&&"6"!==t.key||(t.preventDefault(),i=this.actEast()),"ArrowDown"!==t.key&&"2"!==t.key||(t.preventDefault(),i=this.actSouth()),"ArrowLeft"!==t.key&&"4"!==t.key||(t.preventDefault(),i=this.actWest()),i&&(this.removeEventListener(this.keyDownEvent),e())}actTowardPosition(t){return this.canMoveToPosition(t)?this.moveTo(t):!!this.canAttackPosition(t)&&this.attackPosition(t)}actNorth(){let t={x:this.positionInLevel.x,y:this.positionInLevel.y-1};return this.actTowardPosition(t)}actEast(){let t={x:this.positionInLevel.x+1,y:this.positionInLevel.y};return this.actTowardPosition(t)}actSouth(){let t={x:this.positionInLevel.x,y:this.positionInLevel.y+1};return this.actTowardPosition(t)}actWest(){let t={x:this.positionInLevel.x-1,y:this.positionInLevel.y};return this.actTowardPosition(t)}}const Y={type:"green knight",stats:{maxHealth:10,strength:3,moveCost:100,attackCost:100},spriteName:"greenknight",size:{width:1,height:1},solid:!0,deathrattle:function(t){t.addStructure(new D(N),this.positionInLevel)}},Z=240,tt=176,et=36,it=24,st=16;!async function(){await g.loadLibrary("assets/sprites.json");const t=document.querySelector(".canvas__sorcerer");t.width=Z,t.height=tt;const e=new s({width:et*st,height:it*st});e.setBackgroundColor("#000"),e.useCanvas(t);const i=new X(Y),o=J.createLevel(e,i,"random"),r=new n({width:Z,height:tt},{origin:{x:0,y:0}});r.followGameObject(i),e.addViewport(r),new v({room:e,level:o}).start()}()}]);